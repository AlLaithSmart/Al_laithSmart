<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Switch Dashboard | IoT Control</title>
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- MQTT.js Library for WebSockets -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <style>
        :root {
            --bg-dark: #0f172a;
            --primary: #3b82f6;
            --accent: #06b6d4;
            --success: #10b981;
            --danger: #ef4444;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
        }

        /* --- Layout & Glassmorphism --- */
        .dashboard-container {
            width: 100%;
            max-width: 480px;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: var(--shadow);
            margin: 1rem;
            position: relative;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .device-info { flex: 1; }
        .device-name {
            font-size: 1.25rem;
            font-weight: 700;
            background: none;
            border: none;
            color: var(--text-main);
            border-bottom: 1px dashed var(--text-muted);
            width: 100%;
            margin-bottom: 0.25rem;
        }
        .device-name:focus { outline: none; border-color: var(--accent); }
        .connection-status {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--danger); transition: 0.3s; }
        .dot.connected { background: var(--success); box-shadow: 0 0 10px var(--success); }
        .settings-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
        .settings-btn:hover { color: var(--text-main); transform: rotate(90deg); }

        /* --- Main Switch --- */
        .switch-area {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            position: relative;
        }
        .main-switch {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: rgba(255,255,255,0.03);
            border: 2px solid var(--glass-border);
            position: relative;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }
        .main-switch::before {
            content: '';
            position: absolute;
            inset: -5px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--accent));
            z-index: -1;
            opacity: 0;
            transition: 0.4s;
        }
        .main-switch.active {
            border-color: var(--success);
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.2);
        }
        .main-switch.active::before { opacity: 1; }
        
        .switch-icon { font-size: 3rem; color: var(--text-muted); transition: 0.3s; }
        .main-switch.active .switch-icon { color: #fff; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); }

        .timer-badge {
            position: absolute;
            top: -10px;
            right: 50%;
            transform: translateX(50%);
            background: var(--accent);
            color: #000;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
        }
        .timer-badge.visible { opacity: 1; top: -15px; }

        /* --- Control Tabs --- */
        .tabs { display: flex; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 16px; margin-bottom: 1.5rem; }
        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
        }
        .tab-btn.active { background: var(--glass-bg); color: var(--text-main); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }

        /* --- Panels --- */
        .panel { display: none; animation: fadeIn 0.3s ease; }
        .panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .control-group { margin-bottom: 1rem; }
        .control-group label { display: block; color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.5rem; }
        
        input, select {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 12px;
            border-radius: 10px;
            outline: none;
        }
        input:focus { border-color: var(--primary); }

        .btn {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: var(--success); color: #064e3b; }
        .btn-danger { background: var(--danger); color: white; }

        /* --- Schedule List --- */
        .schedule-list { margin-top: 1rem; max-height: 200px; overflow-y: auto; }
        .schedule-item {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid var(--text-muted);
        }
        .schedule-item.active-on { border-left-color: var(--success); }
        .schedule-item.active-off { border-left-color: var(--danger); }
        .sch-actions button { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 5px; }
        .sch-actions button:hover { color: var(--danger); }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            z-index: 100; display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        .modal {
            background: #1e293b; width: 90%; max-width: 400px; padding: 2rem;
            border-radius: 20px; border: 1px solid var(--glass-border);
            transform: scale(0.9); transition: 0.3s;
        }
        .modal-overlay.open .modal { transform: scale(1); }
        .modal h2 { margin-bottom: 1.5rem; color: var(--text-main); }
        
        .day-selector { display: flex; justify-content: space-between; margin-bottom: 1rem; }
        .day-box {
            width: 35px; height: 35px; border-radius: 50%; background: rgba(255,255,255,0.05);
            display: flex; align-items: center; justify-content: center; font-size: 0.8rem;
            cursor: pointer; user-select: none; transition: 0.2s;
        }
        .day-box.selected { background: var(--primary); color: white; }

        /* --- Toast Notification --- */
        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: var(--glass-bg); color: white; padding: 10px 20px; border-radius: 30px;
            backdrop-filter: blur(10px); border: 1px solid var(--glass-border);
            transition: 0.3s; opacity: 0; z-index: 200; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast i { color: var(--success); }
    </style>
</head>
<body>

<div class="dashboard-container">
    <!-- Header -->
    <header>
        <div class="device-info">
            <input type="text" class="device-name" id="deviceNameDisplay" value="Smart Switch">
            <div class="connection-status">
                <div class="dot" id="statusDot"></div>
                <span id="statusText">Disconnected</span>
            </div>
        </div>
        <button class="settings-btn" onclick="openSettings()"><i class="fa-solid fa-gear"></i></button>
    </header>

    <!-- Main Power Switch -->
    <div class="switch-area">
        <span class="timer-badge" id="timerBadge">00:00</span>
        <div class="main-switch" id="powerSwitch" onclick="togglePower()">
            <i class="fa-solid fa-power-off switch-icon"></i>
        </div>
    </div>

    <!-- Controls -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('timer')"><i class="fa-regular fa-clock"></i> Timer</button>
        <button class="tab-btn" onclick="switchTab('schedule')"><i class="fa-regular fa-calendar"></i> Schedule</button>
    </div>

    <!-- Timer Panel -->
    <div id="panel-timer" class="panel active">
        <div class="control-group">
            <label>Set Duration</label>
            <div style="display: flex; gap: 10px;">
                <input type="number" id="tmH" placeholder="Hrs" min="0" style="width: 30%">
                <input type="number" id="tmM" placeholder="Min" min="0" style="width: 30%">
                <input type="number" id="tmS" placeholder="Sec" min="0" style="width: 30%">
            </div>
        </div>
        <div class="control-group">
            <label>Action After Timer</label>
            <div style="display: flex; gap: 10px;">
                <button class="btn" style="flex:1; background:var(--bg-dark); border:1px solid var(--success); color:var(--success)" onclick="setTimerAction('on')">Turn ON</button>
                <button class="btn" style="flex:1; background:var(--bg-dark); border:1px solid var(--danger); color:var(--danger)" onclick="setTimerAction('off')">Turn OFF</button>
            </div>
        </div>
        <button class="btn btn-primary" onclick="startTimer()">Start Timer <i class="fa-solid fa-play"></i></button>
    </div>

    <!-- Schedule Panel -->
    <div id="panel-schedule" class="panel">
        <button class="btn btn-success" onclick="openScheduleModal()" style="margin-bottom: 1rem;"><i class="fa-solid fa-plus"></i> Add Schedule</button>
        <div class="schedule-list" id="scheduleList">
            <!-- Schedules injected here -->
            <div style="text-align:center; color: var(--text-muted); padding: 20px;">No schedules set</div>
        </div>
    </div>
</div>

<!-- SETTINGS MODAL (Connection) -->
<div class="modal-overlay" id="modalSettings">
    <div class="modal">
        <h2><i class="fa-solid fa-wifi"></i> Connection Setup</h2>
        
        <div class="control-group">
            <label>Connection Mode</label>
            <select id="connMode" onchange="toggleConnFields()">
                <option value="remote">Internet (MQTT)</option>
                <option value="local">Local Network (IP)</option>
            </select>
        </div>

        <!-- Remote Fields -->
        <div id="remoteFields">
            <div class="control-group">
                <label>Device ID</label>
                <input type="text" id="deviceIdInput" placeholder="e.g. DEV-a1b">
            </div>
            <div class="control-group">
                <label>Device Token</label>
                <input type="password" id="deviceTokenInput" placeholder="e.g. TOK-123abc">
            </div>
        </div>

        <!-- Local Fields -->
        <div id="localFields" style="display: none;">
            <div class="control-group">
                <label>Local IP Address</label>
                <input type="text" id="localIpInput" placeholder="http://192.168.1.10">
            </div>
        </div>

        <div class="control-group" style="margin-top: 15px; font-size: 0.8rem; color: var(--text-muted);">
            Broker: broker.hivemq.com (WSS)
        </div>

        <button class="btn btn-primary" onclick="connectDevice()">Connect & Save</button>
        <button class="btn" style="margin-top: 10px; background: transparent; color: var(--text-muted);" onclick="closeModal('modalSettings')">Cancel</button>
    </div>
</div>

<!-- SCHEDULE MODAL -->
<div class="modal-overlay" id="modalSchedule">
    <div class="modal">
        <h2>Add Schedule</h2>
        <div class="control-group">
            <label>Time</label>
            <input type="time" id="schTime">
        </div>
        <div class="control-group">
            <label>Repeat Days</label>
            <div class="day-selector">
                <div class="day-box" onclick="toggleDay(this, 0)">S</div>
                <div class="day-box" onclick="toggleDay(this, 1)">M</div>
                <div class="day-box" onclick="toggleDay(this, 2)">T</div>
                <div class="day-box" onclick="toggleDay(this, 3)">W</div>
                <div class="day-box" onclick="toggleDay(this, 4)">T</div>
                <div class="day-box" onclick="toggleDay(this, 5)">F</div>
                <div class="day-box" onclick="toggleDay(this, 6)">S</div>
            </div>
        </div>
        <div class="control-group">
            <label>Action</label>
            <select id="schAction">
                <option value="on">Turn ON</option>
                <option value="off">Turn OFF</option>
            </select>
        </div>
        <button class="btn btn-success" onclick="saveSchedule()">Save Schedule</button>
        <button class="btn" style="margin-top: 10px; background: transparent; color: var(--text-muted);" onclick="closeModal('modalSchedule')">Cancel</button>
    </div>
</div>

<div class="toast" id="toast"><i class="fa-solid fa-circle-check"></i> <span id="toastMsg">Action Successful</span></div>

<script>
    // --- STATE MANAGEMENT ---
    const state = {
        isConnected: false,
        isRelayOn: false,
        timerEndTime: 0,
        schedules: [],
        mode: 'remote', // 'remote' or 'local'
        deviceId: '',
        deviceToken: '',
        localIp: '',
        client: null,
        tempTimerAction: 'on' // 'on' or 'off' for the next timer
    };

    const MQTT_BROKER = "wss://broker.hivemq.com:8000/mqtt"; // Websocket Secure Port

    // --- INITIALIZATION ---
    window.onload = () => {
        loadConfig();
        if(state.deviceId && state.deviceToken) {
            connectDevice();
        } else {
            openSettings();
        }
        
        // Schedule Checker (Every Second)
        setInterval(checkSchedules, 1000);
        // Timer UI Updater
        setInterval(updateTimerUI, 1000);
    };

    // --- CONNECTION LOGIC ---
    function loadConfig() {
        const saved = localStorage.getItem('iotSwitchConfig');
        if (saved) {
            const config = JSON.parse(saved);
            state.deviceId = config.id;
            state.deviceToken = config.token;
            state.mode = config.mode || 'remote';
            state.localIp = config.ip || '';
            document.getElementById('deviceNameDisplay').value = config.name || 'Smart Switch';
            
            // Restore UI inputs
            document.getElementById('connMode').value = state.mode;
            document.getElementById('deviceIdInput').value = state.deviceId;
            document.getElementById('deviceTokenInput').value = state.deviceToken;
            document.getElementById('localIpInput').value = state.localIp;
            toggleConnFields();
        }
    }

    function saveConfig() {
        const config = {
            id: state.deviceId,
            token: state.deviceToken,
            mode: state.mode,
            ip: state.localIp,
            name: document.getElementById('deviceNameDisplay').value
        };
        localStorage.setItem('iotSwitchConfig', JSON.stringify(config));
    }

    function connectDevice() {
        // Save inputs first
        state.mode = document.getElementById('connMode').value;
        state.deviceId = document.getElementById('deviceIdInput').value.trim();
        state.deviceToken = document.getElementById('deviceTokenInput').value.trim();
        state.localIp = document.getElementById('localIpInput').value.trim();
        
        saveConfig();
        closeModal('modalSettings');

        // Reset UI
        updateStatus(false);

        if (state.mode === 'remote') {
            connectMQTT();
        } else {
            // Local mode simulation - polling via fetch
            showToast("Switched to Local Mode");
            setInterval(pollLocalStatus, 2000);
        }
    }

    function connectMQTT() {
        const clientId = 'web_dash_' + Math.random().toString(16).substr(2, 8);
        
        try {
            state.client = mqtt.connect(MQTT_BROKER, {
                clientId: clientId,
                clean: true,
                connectTimeout: 4000,
            });

            state.client.on('connect', () => {
                console.log("MQTT Connected");
                const topic = "laithsmartswitch/remote/" + state.deviceId + "/status";
                state.client.subscribe(topic);
                updateStatus(true);
                showToast("Connected to Device");
            });

            state.client.on('message', (topic, message) => {
                // ESP Payload Format: {"relay":1, "token":"..."}
                try {
                    const data = JSON.parse(message.toString());
                    updateRelayUI(data.relay === 1);
                    
                    // ESP also sends timerEnd in local JSON, let's see if it sends it via MQTT
                    if(data.timerEnd) {
                        state.timerEndTime = data.timerEnd;
                    }
                } catch (e) {
                    console.error("JSON Parse Error", e);
                }
            });

            state.client.on('error', (err) => {
                console.error("Connection Error: ", err);
                showToast("Connection Failed");
                updateStatus(false);
            });
        } catch (e) {
            console.error("MQTT Library Error", e);
            showToast("MQTT Library not loaded?");
        }
    }

    // --- ACTIONS ---
    function togglePower() {
        if (!state.isConnected && state.mode === 'remote') return showToast("Device Offline");
        
        const newState = !state.isRelayOn;
        sendCommand(newState ? 'on' : 'off');
        updateRelayUI(newState); // Optimistic update
    }

    function sendCommand(action) {
        // Must match ESP format: {"command":"'on'"}
        // Note the single quotes inside the string are crucial for the ESP's indexOf check
        const payload = `{"command":"'${action}'"}`;

        if (state.mode === 'remote') {
            const topic = "laithsmartswitch/remote/" + state.deviceId + "/control";
            state.client.publish(topic, payload);
        } else {
            // Local Fetch
            fetch(`${state.localIp}/setRelay?state=${action === 'on' ? 1 : 0}`).catch(e => console.log(e));
        }
    }

    function setTimerAction(action) {
        state.tempTimerAction = action;
        // Visual feedback for buttons
        const btns = document.querySelectorAll('#panel-timer .btn');
        btns.forEach(b => {
            if(b.textContent.includes('Turn ON')) b.style.opacity = action === 'on' ? '1' : '0.5';
            if(b.textContent.includes('Turn OFF')) b.style.opacity = action === 'off' ? '1' : '0.5';
        });
    }

    function startTimer() {
        if (!state.isConnected && state.mode === 'remote') return showToast("Device Offline");

        const h = parseInt(document.getElementById('tmH').value) || 0;
        const m = parseInt(document.getElementById('tmM').value) || 0;
        const s = parseInt(document.getElementById('tmS').value) || 0;
        const totalSec = (h * 3600) + (m * 60) + s;

        if (totalSec <= 0) return showToast("Please set a time");

        // ESP Payload Format: {"timer":{"seconds":60,"action":"on"}}
        const payload = JSON.stringify({
            timer: {
                seconds: totalSec,
                action: state.tempTimerAction
            }
        });

        if (state.mode === 'remote') {
            const topic = "laithsmartswitch/remote/" + state.deviceId + "/control";
            state.client.publish(topic, payload);
        } else {
            fetch(`${state.localIp}/setTimer?seconds=${totalSec}&action=${state.tempTimerAction}`);
        }

        // Set local countdown UI (Optimistic)
        state.timerEndTime = Date.now() + (totalSec * 1000);
        document.getElementById('timerBadge').classList.add('visible');
        showToast("Timer Set");
        
        // Switch back to main tab to see countdown
        // switchTab('timer'); 
    }

    // --- SCHEDULE LOGIC (Client Side) ---
    // Since the ESP logic provided has schedules inside the HTML, we implement them here too.
    // When a schedule triggers, we send an MQTT command.

    function checkSchedules() {
        if (state.schedules.length === 0) return;

        const now = new Date();
        const currentDay = String(now.getDay());
        const currentHours = now.getHours();
        const currentMin = now.getMinutes();
        const currentSeconds = now.getSeconds();
        
        // Time Value in Minutes for easier comparison
        // Note: We allow a 1-second window to trigger the action
        const currentTimeVal = (currentHours * 3600) + (currentMin * 60) + currentSeconds;

        state.schedules.forEach(sch => {
            if (!sch.lastTriggered || (Date.now() - sch.lastTriggered > 2000)) { // Debounce 2s
                if (sch.days.includes(currentDay)) {
                    const [h, m] = sch.time.split(':');
                    const schTimeVal = (parseInt(h) * 3600) + (parseInt(m) * 60);
                    
                    if (currentTimeVal >= schTimeVal && currentTimeVal < schTimeVal + 2) {
                        console.log("Triggering Schedule:", sch.action);
                        sendCommand(sch.action);
                        sch.lastTriggered = Date.now();
                        showToast(`Schedule: ${sch.action.toUpperCase()}`);
                    }
                }
            }
        });
    }

    // --- UI HELPERS ---
    function updateStatus(connected) {
        state.isConnected = connected;
        const dot = document.getElementById('statusDot');
        const text = document.getElementById('statusText');
        if (connected) {
            dot.classList.add('connected');
            text.innerText = "Online (" + state.mode + ")";
            text.style.color = "var(--success)";
        } else {
            dot.classList.remove('connected');
            text.innerText = "Offline";
            text.style.color = "var(--danger)";
        }
    }

    function updateRelayUI(isOn) {
        state.isRelayOn = isOn;
        const sw = document.getElementById('powerSwitch');
        if (isOn) {
            sw.classList.add('active');
        } else {
            sw.classList.remove('active');
        }
    }

    function updateTimerUI() {
        if (state.timerEndTime > 0) {
            const now = Date.now();
            if (now < state.timerEndTime) {
                const diff = Math.floor((state.timerEndTime - now) / 1000);
                const h = Math.floor(diff / 3600);
                const m = Math.floor((diff % 3600) / 60);
                const s = diff % 60;
                document.getElementById('timerBadge').innerText = 
                    `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                document.getElementById('timerBadge').classList.add('visible');
            } else {
                state.timerEndTime = 0;
                document.getElementById('timerBadge').classList.remove('visible');
            }
        }
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        
        // Find button by text content roughly or index
        if(tab === 'timer') document.querySelectorAll('.tab-btn')[0].classList.add('active');
        if(tab === 'schedule') document.querySelectorAll('.tab-btn')[1].classList.add('active');
        
        document.getElementById('panel-' + tab).classList.add('active');
    }

    function openSettings() { document.getElementById('modalSettings').classList.add('open'); }
    function closeModal(id) { document.getElementById(id).classList.remove('open'); }
    
    function toggleConnFields() {
        const mode = document.getElementById('connMode').value;
        if(mode === 'remote') {
            document.getElementById('remoteFields').style.display = 'block';
            document.getElementById('localFields').style.display = 'none';
        } else {
            document.getElementById('remoteFields').style.display = 'none';
            document.getElementById('localFields').style.display = 'block';
        }
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        document.getElementById('toastMsg').innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    // --- SCHEDULE MODAL LOGIC ---
    function openScheduleModal() { document.getElementById('modalSchedule').classList.add('open'); }
    
    function toggleDay(el, dayIdx) {
        el.classList.toggle('selected');
        el.dataset.day = dayIdx;
    }

    function saveSchedule() {
        const time = document.getElementById('schTime').value;
        const action = document.getElementById('schAction').value;
        const days = [];
        
        document.querySelectorAll('.day-box.selected').forEach(d => days.push(d.dataset.day));
        
        if(!time || days.length === 0) return showToast("Missing Time or Day");

        state.schedules.push({ time, action, days, lastTriggered: 0 });
        renderSchedules();
        closeModal('modalSchedule');
        showToast("Schedule Added");
    }

    function renderSchedules() {
        const list = document.getElementById('scheduleList');
        list.innerHTML = "";
        const dayNames = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
        
        state.schedules.forEach((sch, idx) => {
            const div = document.createElement('div');
            div.className = `schedule-item active-${sch.action}`;
            div.innerHTML = `
                <div>
                    <div style="font-weight:bold; color:white">${sch.time} <span style="font-size:0.8em; color:var(--text-muted)">(${sch.action.toUpperCase()})</span></div>
                    <div style="font-size:0.8em; color:var(--text-muted)">${sch.days.map(d=>dayNames[d]).join(', ')}</div>
                </div>
                <div class="sch-actions">
                    <button onclick="deleteSchedule(${idx})"><i class="fa-solid fa-trash"></i></button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function deleteSchedule(idx) {
        state.schedules.splice(idx, 1);
        renderSchedules();
    }
    
    // Local polling function for Local Mode
    function pollLocalStatus() {
        if(state.mode !== 'local') return;
        // Optimistic: Don't hammer the IP if it fails, but for demo this is fine
        fetch(`${state.localIp}/status`)
            .then(r => r.json())
            .then(data => {
                updateStatus(true);
                updateRelayUI(data.relay === 1);
                if(data.timerEnd) state.timerEndTime = data.timerEnd;
            })
            .catch(e => {
                updateStatus(false);
            });
    }

</script>
</body>
</html>
